---
title: "平均负载上下文切换"
date: 2018-12-10T10:37:23+08:00
weight: 1
---

## 平均负载
 平均负载是指单位时间内，系统处于可运行状态和不可中断状态的平均进程数，也就是平均活跃进程数，它和 CPU 使用率并没有直接关系。

### 平均负载最理想的情况是等于 CPU 个数。
查看CPU个数
```
$ grep 'model name' /proc/cpuinfo |wc -l
6
```

### 运行 uptime 查看平均负载的变化情况
```
# -n或--interval watch 缺省每2秒运行一下程序，多用于周期性执行命令/定时执行命令
# -d 参数表示高亮显示变化的区域
$ watch -d uptime
09:12:47 up 19 days, 17:21,  2 users,  load average: 1.43, 0.96, 0.84
...
```

```
09:12:47           // 当前时间
9 days, 17:21      // 系统运行时间
2 users            // 正在登录用户数
load average: 1.43, 0.96, 0.84  // 过去1分钟，5分钟，15分钟的平均负载
```

### 运行 mpstat 查看 CPU 使用率的变化情况
```
# -P ALL 表示监控所有 CPU，后面数字 5 表示间隔 5 秒后输出一组数据
$ mpstat -P ALL 5
Linux 3.10.0-514.26.2.el7.x86_64 (csv-dcosstorage01.zj.chinamobile.com) 	11/29/2018 	_x86_64_	(6 CPU)

09:29:49 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
09:29:54 AM  all   13.06    0.00    1.07    0.03    0.00    0.07    0.00    0.00    0.00   85.77
09:29:54 AM    0    4.80    0.00    1.40    0.00    0.00    0.00    0.00    0.00    0.00   93.80
09:29:54 AM    1   30.06    0.00    1.00    0.00    0.00    0.00    0.00    0.00    0.00   68.94
09:29:54 AM    2   26.16    0.00    0.60    0.20    0.00    0.00    0.00    0.00    0.00   73.04
09:29:54 AM    3   10.44    0.00    1.81    0.00    0.00    0.20    0.00    0.00    0.00   87.55
09:29:54 AM    4    4.01    0.00    0.60    0.00    0.00    0.00    0.00    0.00    0.00   95.39
09:29:54 AM    5    3.01    0.00    0.80    0.00    0.00    0.00    0.00    0.00    0.00   96.19
...
```

### 运行 pidstat 主要用于监控全部或指定进程占用系统资源的情况 
```
# -u cpu
# -r 内存
# -d 磁盘IO
# 间隔 5 秒后输出 2 组数据
$ pidstat -u 5 2
Linux 3.10.0-514.26.2.el7.x86_64 (csv-dcosstorage01.zj.chinamobile.com) 	11/29/2018 	_x86_64_	(6 CPU)

09:38:55 AM   UID       PID    %usr %system  %guest    %CPU   CPU  Command
09:39:00 AM     0         9    0.00    0.20    0.00    0.20     0  rcu_sched
09:39:00 AM     0       729    0.20    0.00    0.00    0.20     2  vmtoolsd
...
```

```
# 查看指定进程占用系统资源的情况
$ pidstat -p 24344
```
### 小结
平均负载提供了一个快速查看系统整体性能的手段，反映了整体的负载情况。但只看平均负载本身，我们并不能直接发现，到底是哪里出现了瓶颈。所以，在理解平均负载时，也要注意：   
- 平均负载高有可能是 CPU 密集型进程导致的；
- 平均负载高并不一定代表 CPU 使用率高，还有可能是 I/O 更繁忙了；
- 当发现负载高的时候，你可以使用 mpstat、pidstat 等工具，辅助分析负载的来源。

***

## CPU 上下文切换
### 原理分析
1. 多任务竞争CPU，cpu变换任务的时候进行CPU上下文切换(context switch)。CPU执行任务有4种方式：进程、线程、或者硬件通过触发信号导致中断的调用。

2. 当切换任务的时候，需要记录任务当前的状态和获取下一任务的信息和地址(指针)，这就是上下文的内容。因此，上下文是指某一时间点CPU寄存器(CPU register)和程序计数器(PC)的内容, 广义上还包括内存中进程的虚拟地址映射信息.

3. 上下文切换的过程：
 - 记录当前任务的上下文(即寄存器和计算器等所有的状态)；
 - 找到新任务的上下文并加载；
 - 切换到新任务的程序计算器位置，恢复其任务。

4. 根据任务的执行形式，相应的下上文切换，有进程上下文切换、线程上下文切换、以及中断上下文切换三类。

5. 进程上下文切换：是指从一个进程切换到另一个进程。
- 进程运行态为内核运行态和进程运行态。内核空间态资源包括内核的堆栈、寄存器等；用户空间态资源包括虚拟内存、栈、变量、正文、数据等
- 系统调用(软中断)在内核态完成的，需要进行2次CPU上下文切换(用户空间-->内核空间-->用户空间)，不涉及用户态资源，也不会切换进程。
- 进程是由内核来管理和调度的，进程的切换只能发生在内核态。所以，进程的上下文不仅包括了用户空间的资源，也包括内核空间资源。
- 进程的上下文切换过程：
```
(a)接收到切换信号，挂起进程，记录当前进程的虚拟内存、栈等资源存储;
(b)将这个进程在 CPU 中的上下文状态存储于起来;
(c)然后在内存中检索下一个进程的上下文;
(d)并将其加载到 CPU的寄存器中恢复;
(e)还需要刷新进程的虚拟内存和用户栈;
(f)最后跳转到程序计数器所指向的位置（即跳转到进程被中断时的代码行），以恢复该进程。
```
- 下列将会触发进程上下文切换的场景：
```
(a)、根据调度策略，将CPU时间划片为对应的时间片，当时间片耗尽，当前进程必须挂起。
(b)、资源不足的，在获取到足够资源之前进程挂起。
(c)、进程sleep挂起进程。
(d)、高优先级进程导致当前进度挂起
(e)、硬件中断，导致当前进程挂起
```
6. 线程上下文切换：
(1)、不通进程之间的线程上下文切换，其过程和进程上下文切换大致相同。
(2)、进程内部的线程进上下文切换。不需要切换进程的用户资源，只需要切换线程私有的数据和寄存器等。这会比进程上下文进程切换消耗的资源少，所以多线程相比多进程的优势。
7. 中断上下文切换
快速响应硬件的事件，中断处理会打断进程的正常调度和执行。同一CPU内，硬件中断优先级高于进程。切换过程类似于系统调用的时候，不涉及到用户运行态资源。但大量的中断上下文切换同样可能引发性能问题。
8. 进程和线程的区别：
进程是资源分配和执行的基本单位；线程是任务调度和运行的基本单位。线程没有资源，进程给指针提供虚拟内存、栈、变量等共享资源，而线程可以共享进程的资源。

### 查看系统的上下文切换情况
vmstat 是一个常用的系统性能分析工具，主要用来分析系统的内存使用情况，也常用来分析 CPU 上下文切换和中断的次数。
- cs（context switch）是每秒上下文切换的次数。
- in（interrupt）则是每秒中断的次数。
- r（Running or Runnable）是就绪队列的长度，也就是正在运行和等待 CPU 的进程数。
- b（Blocked）则是处于不可中断睡眠状态的进程数。
```
# 每隔 5 秒输出 1 组数据
$ vmstat 5
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 563080    392 9227604    0    0   113    33    4    3 10  1 89  0  0
```

```
# 每隔 1 秒输出 1 组数据（需要 Ctrl+C 才结束）
# -w 参数表示输出进程切换指标,而 -u 参数则表示输出 CPU 使用指标
$ pidstat -w -u 1
08:06:33      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
10:43:38 AM   UID       PID    %usr %system  %guest    %CPU   CPU  Command
10:43:39 AM     0         1    1.00    1.00    0.00    2.00     5  systemd
10:43:39 AM     0       733    2.00    0.00    0.00    2.00     3  rngd
...
10:43:38 AM   UID       PID   cswch/s nvcswch/s  Command
10:43:39 AM     0         1      9.00      0.00  systemd
10:43:39 AM     0         2     10.00      0.00  kthreadd
```

```
# 每隔 1 秒输出一组数据（需要 Ctrl+C 才结束）
# -wt 参数表示输出线程的上下文切换指标
$ pidstat -wt 1
Linux 3.10.0-514.26.2.el7.x86_64 (csv-dcosstorage01.zj.chinamobile.com) 	11/29/2018 	_x86_64_	(6 CPU)
10:46:22 AM   UID      TGID       TID   cswch/s 
10:46:23 AM     0         9         -    146.69      0.00  rcu_sched
10:46:23 AM     0         -         9    146.69      0.00  |__rcu_sched
...
```

### 小结

每秒上下文切换多少次正常取决于系统本身的 CPU 性能。如果系统的上下文切换次数比较稳定，那么从数百到一万以内，都应该算是正常的。但当上下文切换次数超过一万次，或者切换次数出现数量级的增长时，就很可能已经出现了性能问题。
- 自愿上下文切换变多了，说明进程都在等待资源，有可能发生了 I/O 等其他问题； 
- 非自愿上下文切换变多了，说明进程都在被强制调度，也就是都在争抢 CPU，说明 CPU 的确成了瓶颈；
- 中断次数变多了，说明 CPU 被中断处理程序占用，还需要通过查看 /proc/interrupts 文件来分析具体中断类型。

***

